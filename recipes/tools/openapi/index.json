{
  "url": "file:///Users/paulkinlan/Code/labs-prototypes/recipes/tools/openapi/index.js",
  "title": "Create a board from an Open API spec",
  "description": "Converts an Open API spec to a board.",
  "version": "0.0.3",
  "edges": [
    {
      "from": "splatBoards",
      "to": "output-2",
      "out": "*",
      "in": ""
    },
    {
      "from": "createFetchBoards",
      "to": "splatBoards",
      "out": "list",
      "in": "list"
    },
    {
      "from": "generateAPISpecs",
      "to": "createFetchBoards",
      "out": "*",
      "in": ""
    },
    {
      "from": "fetch-3",
      "to": "isOpenAPI",
      "out": "response",
      "in": "json"
    },
    {
      "from": "fetch-3",
      "to": "generateAPISpecs",
      "out": "response",
      "in": "json"
    },
    {
      "from": "input",
      "to": "fetch-3",
      "out": "*",
      "in": ""
    }
  ],
  "nodes": [
    {
      "id": "output-2",
      "type": "output",
      "configuration": {}
    },
    {
      "id": "splatBoards",
      "type": "invoke",
      "configuration": {
        "path": "#splatBoards"
      }
    },
    {
      "id": "createFetchBoards",
      "type": "map",
      "configuration": {
        "board": {
          "kind": "board",
          "board": {
            "kits": [],
            "edges": [
              {
                "from": "input-1",
                "to": "output-3",
                "out": "item",
                "in": "item"
              },
              {
                "from": "input-1",
                "to": "lambda-5",
                "out": "item",
                "in": "item"
              },
              {
                "from": "lambda-5",
                "to": "output-3",
                "out": "board",
                "in": "board"
              }
            ],
            "nodes": [
              {
                "id": "output-3",
                "type": "output",
                "configuration": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "item": {
                        "type": "string",
                        "title": "item"
                      },
                      "board": {
                        "type": "string",
                        "title": "board"
                      }
                    },
                    "required": [
                      "item",
                      "board"
                    ]
                  }
                }
              },
              {
                "id": "input-1",
                "type": "input",
                "configuration": {
                  "schema": {
                    "type": "object",
                    "properties": {
                      "item": {
                        "type": "string",
                        "title": "item"
                      }
                    },
                    "required": [
                      "item"
                    ]
                  }
                }
              },
              {
                "id": "lambda-5",
                "type": "lambda",
                "configuration": {
                  "board": {
                    "kind": "board",
                    "board": {
                      "kits": [],
                      "edges": [
                        {
                          "from": "fetch-3",
                          "to": "output-5",
                          "out": "response",
                          "in": "api_json_response"
                        },
                        {
                          "from": "fn-4",
                          "to": "fetch-3",
                          "out": "*",
                          "in": ""
                        },
                        {
                          "from": "input-1",
                          "to": "fn-4",
                          "out": "*",
                          "in": ""
                        }
                      ],
                      "nodes": [
                        {
                          "id": "output-5",
                          "type": "output",
                          "configuration": {
                            "schema": {
                              "type": "object",
                              "properties": {
                                "api_json_response": {
                                  "title": "response",
                                  "description": "The response from the fetch request",
                                  "type": [
                                    "string",
                                    "object"
                                  ]
                                }
                              },
                              "required": [
                                "api_json_response"
                              ]
                            }
                          }
                        },
                        {
                          "id": "fetch-3",
                          "type": "fetch",
                          "configuration": {}
                        },
                        {
                          "id": "fn-4",
                          "type": "invoke",
                          "configuration": {
                            "path": "#fn-4"
                          }
                        },
                        {
                          "id": "input-1",
                          "type": "input",
                          "configuration": {}
                        }
                      ],
                      "graphs": {
                        "fn-4": {
                          "edges": [
                            {
                              "from": "fn-4-input",
                              "to": "fn-4-run",
                              "out": "*"
                            },
                            {
                              "from": "fn-4-run",
                              "to": "fn-4-output",
                              "out": "*"
                            }
                          ],
                          "nodes": [
                            {
                              "id": "fn-4-input",
                              "type": "input",
                              "configuration": {}
                            },
                            {
                              "id": "fn-4-run",
                              "type": "runJavascript",
                              "configuration": {
                                "code": "function fn_4(itemToSplat) {\n            return { ...itemToSplat.item };\n          }",
                                "name": "fn_4",
                                "raw": true
                              }
                            },
                            {
                              "id": "fn-4-output",
                              "type": "output",
                              "configuration": {}
                            }
                          ]
                        }
                      }
                    }
                  }
                }
              }
            ],
            "graphs": {}
          }
        }
      }
    },
    {
      "id": "generateAPISpecs",
      "type": "invoke",
      "configuration": {
        "path": "#generateAPISpecs"
      }
    },
    {
      "id": "fetch-3",
      "type": "fetch",
      "configuration": {}
    },
    {
      "id": "input",
      "type": "input",
      "configuration": {
        "schema": {
          "type": "object",
          "properties": {
            "url": {
              "type": "string",
              "title": "Open API URL",
              "description": "The URL of the Open API spec that you want to convert to a board."
            }
          }
        }
      }
    },
    {
      "id": "isOpenAPI",
      "type": "invoke",
      "configuration": {
        "path": "#isOpenAPI"
      }
    }
  ],
  "kits": [],
  "graphs": {
    "splatBoards": {
      "edges": [
        {
          "from": "splatBoards-input",
          "to": "splatBoards-run",
          "out": "*"
        },
        {
          "from": "splatBoards-run",
          "to": "splatBoards-output",
          "out": "*"
        }
      ],
      "nodes": [
        {
          "id": "splatBoards-input",
          "type": "input",
          "configuration": {}
        },
        {
          "id": "splatBoards-run",
          "type": "runJavascript",
          "configuration": {
            "code": "function splatBoards({ list }) {\n    const operations = list\n      .map((item) => {\n        return {\n          [item.item.operationId]: item.board,\n        };\n      })\n      .reduce((acc, curr) => {\n        return { ...acc, ...curr };\n      }, {});\n    return { ...operations };\n  }",
            "name": "splatBoards",
            "raw": true
          }
        },
        {
          "id": "splatBoards-output",
          "type": "output",
          "configuration": {}
        }
      ]
    },
    "generateAPISpecs": {
      "edges": [
        {
          "from": "generateAPISpecs-input",
          "to": "generateAPISpecs-run",
          "out": "*"
        },
        {
          "from": "generateAPISpecs-run",
          "to": "generateAPISpecs-output",
          "out": "*"
        }
      ],
      "nodes": [
        {
          "id": "generateAPISpecs-input",
          "type": "input",
          "configuration": {}
        },
        {
          "id": "generateAPISpecs-run",
          "type": "runJavascript",
          "configuration": {
            "code": "function generateAPISpecs({ json }) {\n    const { paths } = json;\n    const baseUrl = json.servers[0].url;\n\n    const inferOperationId = (path, method, values) => {\n      // If there is no operation ID, generate one from the path, but format it like a JS function name\n      let newName = path\n        .split(\"/\")\n        .map((part) =>\n          part.length == 0 ? part : part[0].toUpperCase() + part.slice(1)\n        )\n        .join(\"\")\n        .replace(/[.-]/g, \"\") // Remove dashes and dots\n        .replace(/[{}]/g, \"\"); // Remove curly braces (need to improve this)\n\n      return `${method}${newName}`;\n    };\n\n    const apis = Object.entries(paths)\n      .map(([key, value]) => {\n        return Object.keys(value)\n          .map((method) => {\n            // Operation ID might not exist.\n            const operationId =\n              value[method].operationId ||\n              inferOperationId(key, method, value[method]);\n\n            const headers = {\n              operationId,\n              url: baseUrl.replace(/\\/$/, \"\") + key,\n              method: method.toUpperCase(),\n            };\n\n            return headers;\n          })\n          .flat();\n      })\n      .flat();\n\n    return { list: apis };\n  }",
            "name": "generateAPISpecs",
            "raw": true
          }
        },
        {
          "id": "generateAPISpecs-output",
          "type": "output",
          "configuration": {}
        }
      ]
    },
    "isOpenAPI": {
      "edges": [
        {
          "from": "isOpenAPI-input",
          "to": "isOpenAPI-run",
          "out": "*"
        },
        {
          "from": "isOpenAPI-run",
          "to": "isOpenAPI-output",
          "out": "*"
        }
      ],
      "nodes": [
        {
          "id": "isOpenAPI-input",
          "type": "input",
          "configuration": {}
        },
        {
          "id": "isOpenAPI-run",
          "type": "runJavascript",
          "configuration": {
            "code": "function isOpenAPI({ json }) {\n    if (\"openapi\" in json == false) {\n      throw new Error(\"Not an Open API spec.\");\n    }\n\n    if (\"servers\" in json == false) {\n      throw new Error(\"No servers in Open API spec.\");\n    }\n\n    if (\"paths\" in json == false) {\n      throw new Error(\"No paths in Open API spec.\");\n    }\n\n    return { json };\n  }",
            "name": "isOpenAPI",
            "raw": true
          }
        },
        {
          "id": "isOpenAPI-output",
          "type": "output",
          "configuration": {}
        }
      ]
    }
  }
}
