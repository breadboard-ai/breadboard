/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */

import type { DriveFileId } from "@breadboard-ai/utils/google-drive/google-drive-client.js";
import { SignalWatcher } from "@lit-labs/signals";
import { consume } from "@lit/context";
import "@material/web/switch/switch.js";
import { type MdSwitch } from "@material/web/switch/switch.js";
import { css, html, LitElement, nothing } from "lit";
import { customElement, property } from "lit/decorators.js";
import { createRef, ref } from "lit/directives/ref.js";
import { scaContext } from "../../../sca/context/context.js";
import type { SharePanelStatus } from "../../../sca/controller/subcontrollers/editor/share-controller.js";
import { SCA } from "../../../sca/sca.js";
import animations from "../../app-templates/shared/styles/animations.js";
import { ToastEvent, ToastType } from "../../events/events.js";
import * as StringsHelper from "../../strings/helper.js";
import { buttonStyles } from "../../styles/button.js";
import { icons } from "../../styles/icons.js";
import { type GoogleDriveSharePanel } from "../elements.js";
import { CLIENT_DEPLOYMENT_CONFIG } from "../../config/client-deployment-configuration.js";
import type { VisibilityLevel } from "./share-visibility-selector.js";
import "./share-visibility-selector.js";

const APP_NAME = StringsHelper.forSection("Global").from("APP_NAME");
const Strings = StringsHelper.forSection("UIController");
const SHARING_V2 = CLIENT_DEPLOYMENT_CONFIG.ENABLE_SHARING_2;

@customElement("bb-share-panel")
export class SharePanel extends SignalWatcher(LitElement) {
  static styles = [
    icons,
    buttonStyles,
    animations,
    css`
      :host {
        display: contents;
      }

      dialog {
        border-radius: var(--bb-grid-size-4);
        border: none;
        box-shadow:
          0px 4px 8px 3px rgba(0, 0, 0, 0.15),
          0px 1px 3px 0px rgba(0, 0, 0, 0.3);
        font-family: var(--bb-font-family);
        padding: var(--bb-grid-size-5);
        width: 500px;
        min-height: 196px;
        display: flex;
        flex-direction: column;

        /* Match the backdrop of the Google Drive sharing panel, whose style we
           don't (easily) control, and which will replace our own dialog if the
           user clicks "View permissions". */
        &::backdrop {
          background-color: #fff;
          opacity: 50%;
        }

        & #advisory {
          color: var(--light-dark-n-40);
          font: 400 var(--bb-label-medium) / var(--bb-label-line-height-medium)
            var(--bb-font-family);
          margin: var(--bb-grid-size-6) 0 0 0;

          a {
            color: var(--light-dark-p-40);
          }
        }
      }

      header {
        display: flex;
        justify-content: space-between;
      }
      h2 {
        font: 500 var(--bb-title-medium) / var(--bb-title-line-height-medium)
          var(--bb-font-family);
        margin: 0;
      }
      #close-button {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        font-size: 24px;
      }

      dialog.sharing-v2 {
        padding: var(--bb-grid-size-6);

        h2 {
          font: 400 var(--bb-title-large) / var(--bb-title-line-height-large)
            var(--bb-font-family);
          color: #243351;
        }

        #app-link {
          align-items: center;

          #app-link-text {
            background: none;
            color: #525252;
            border: none;
          }

          #app-link-copy-button {
            width: 150px;
            height: 40px;
            border: 1px solid #f1f1f1;
            background: #fff;
            padding: 10px 16px;
            gap: var(--bb-grid-size-2);
            font-family: var(--bb-font-family-flex);
            font-size: 14px;
            line-height: 20px;
            letter-spacing: 0;

            &.bb-button-outlined {
              color: #1b1b1b;
            }

            &:hover {
              background: #f1f1f1;
              border-color: #ababab;
            }
          }
        }
      }

      #advisory-v2 {
        color: var(--light-dark-n-40);
        font: 400 var(--bb-label-medium) / var(--bb-label-line-height-medium)
          var(--bb-font-family);
        margin: var(--bb-grid-size-8) 0 0 0;

        a {
          color: #665ef6;
          font-weight: 700;
          letter-spacing: 0.1px;
          text-decoration: none;

          &:hover {
            text-decoration: underline;
          }
        }
      }

      #editor-access-toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: var(--bb-grid-size-9);

        label {
          display: flex;
          align-items: center;
          gap: var(--bb-grid-size-2);
          color: var(--Text, #1b1b1b);
          font-family: var(--bb-font-family-flex);
          font-size: 16px;
          font-weight: 500;
          line-height: 24px;
          letter-spacing: 0;
        }

        .info-icon {
          position: relative;
          font-size: 16px;
          width: 16px;
          height: 16px;
          overflow: visible;
          color: #525252;
          padding: 4px;
          margin: -4px;
          cursor: help;
        }

        .info-icon::after {
          content: attr(data-tooltip);
          position: absolute;
          bottom: calc(100% + 8px);
          left: 50%;
          transform: translateX(-50%);
          background: #2e2e2e;
          color: #f2f2f2;
          font-family: var(--bb-font-family-flex);
          font-size: 12px;
          font-weight: 400;
          line-height: 16px;
          letter-spacing: 0.1px;
          padding: 4px 8px;
          border-radius: 4px;
          width: max-content;
          max-width: 300px;
          white-space: normal;
          pointer-events: none;
          opacity: 0;
          transition: opacity 0.15s ease;
        }

        .info-icon:hover::after {
          opacity: 1;
        }

        md-switch {
          --md-sys-color-primary: #000;
          --md-sys-color-primary-container: #fff;
          --md-sys-color-surface-container-highest: #e0e0e0;
          --md-switch-track-height: 24px;
          --md-switch-track-width: 40px;
          --md-switch-selected-handle-width: 20px;
          --md-switch-selected-handle-height: 20px;
        }
      }

      #editor-access-toggle + #app-link {
        margin-top: 44px;
      }

      footer {
        display: flex;
        justify-content: flex-end;
        margin-top: var(--bb-grid-size-12);

        .bb-button-outlined {
          flex-direction: column;
          padding: 10px 16px;
          border: 1px solid #ababab;
          color: #1b1b1b;
          font-family: var(--bb-font-family-flex);
          font-size: 14px;
          line-height: 20px;
          letter-spacing: 0;
        }
      }

      #loading {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        font: 400 var(--bb-label-large) / var(--bb-label-line-height-large)
          var(--bb-font-family);
        .spinner {
          margin-right: var(--bb-grid-size-2);
        }
      }

      #readonly {
        margin: auto 0 auto 0;
        #app-link {
          margin: 0;
        }
      }

      #stale {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--light-dark-n-98);
        margin: var(--bb-grid-size-4) calc(-1 * var(--bb-grid-size-5)) 0
          calc(-1 * var(--bb-grid-size-5));
        padding: 0 var(--bb-grid-size-6);
        font: 400 var(--bb-label-large) / var(--bb-label-line-height-large)
          var(--bb-font-family);
        color: var(--sys-color--inverse-on-surface);

        .g-icon {
          vertical-align: middle;
          margin-right: var(--bb-grid-size-3);
        }

        button[disabled] {
          cursor: wait;
        }
      }

      #stale-v2 {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: var(--bb-grid-size-4);
        background: #f1f1f1;
        margin: var(--bb-grid-size-4) calc(-1 * var(--bb-grid-size-6)) 0
          calc(-1 * var(--bb-grid-size-6));
        padding: var(--bb-grid-size-4) var(--bb-grid-size-6);
        font-family: var(--bb-font-family-flex);
        font-size: 14px;
        font-weight: 400;
        line-height: normal;
        letter-spacing: 0;
        color: #1a1a1a;

        button {
          font: 700 var(--bb-label-large) / 16px var(--bb-font-family);
          color: #000;
          letter-spacing: 0.25px;
          flex-shrink: 0;
        }

        button[disabled] {
          cursor: wait;
        }
      }

      #stale-v2 + #advisory-v2 {
        margin-top: var(--bb-grid-size-4);
      }

      #permissions {
        display: flex;
        justify-content: space-between;
        margin-top: var(--bb-grid-size-8);
        min-height: 24px;
        font: 500 var(--bb-title-medium) / var(--bb-title-line-height-medium)
          var(--bb-font-family);
      }
      #disallowed-publishing-notice {
        font: 400 var(--bb-label-medium) / var(--bb-label-line-height-medium)
          var(--bb-font-family);
        text-align: right;
        color: var(--light-dark-e-50);
        max-width: 360px;
        align-self: flex-end;
        margin-top: var(--bb-grid-size-3);
        > a,
        > a:visited {
          color: var(--light-dark-p-40);
          &:hover {
            color: var(--light-dark-p-60);
          }
        }
        > .g-icon {
          vertical-align: middle;
          margin: 0 4px 2px 0;
        }
      }
      #granular-sharing-link {
        text-decoration: none;
        color: var(--ui-custom-o-100);
        font: 500 var(--bb-label-large) / var(--bb-label-line-height-large)
          var(--bb-font-family);
        margin: var(--bb-grid-size-6) 0 0 0;

        &:hover {
          text-decoration: underline;
        }

        &[disabled] {
          opacity: 60%;
          cursor: wait;
          &:hover {
            text-decoration: none;
          }
        }
      }
      #published-switch-container {
        display: flex;
        align-items: center;
        .spinner {
          margin-right: var(--bb-grid-size-3);
        }
        md-switch {
          --md-switch-track-width: 40px;
          --md-switch-track-height: 24px;
          --md-switch-selected-handle-width: 20px;
          --md-switch-selected-handle-height: 20px;
          --md-sys-color-primary: var(--light-dark-n-10);
          --md-sys-color-primary-container: var(--light-dark-n-98);
          --md-sys-color-surface: var(--light-dark-n-80);
          --md-sys-color-surface-container-highest: var(--light-dark-n-98);
          --md-sys-color-outline: var(--light-dark-n-50);
          &[disabled] {
            cursor: wait;
          }
        }
        label {
          display: inline-block;
          width: 4.5em;
          margin: 0 var(--bb-grid-size) 0 var(--bb-grid-size-2);
          font: 500 var(--bb-label-large) / var(--bb-label-line-height-large)
            var(--bb-font-family);
          text-align: center;
          color: var(--sys-color--on-surface);
        }
      }

      #app-link {
        display: flex;
        margin: var(--bb-grid-size-7) 0 0 0;

        #app-link-text {
          flex: 1;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
          border: 1px solid var(--light-dark-n-98);
          padding: 0 var(--bb-grid-size-3);
          border-radius: var(--bb-grid-size-2);
          font: 500 var(--bb-body-large) / var(--bb-body-line-height-large)
            var(--bb-font-family);
        }

        #app-link-copy-button {
          margin-left: var(--bb-grid-size-8);
          border-color: var(--light-dark-n-98);
          font-weight: 500;

          &.bb-button-outlined {
            color: var(--sys-color--on-surface-low);
          }
        }
      }

      .g-icon {
        /* Our default icon weight is too thin. */
        font-variation-settings:
          "FILL" 0,
          "wght" 600,
          "GRAD" 0,
          "opsz" 48;
      }

      #unmanaged-assets {
        p {
          font: 400 var(--bb-body-medium) / var(--bb-body-line-height-medium)
            var(--bb-font-family);
          margin: var(--bb-grid-size-7) 0 var(--bb-grid-size) 0;
          &:first-of-type {
            margin-top: var(--bb-grid-size-5);
          }
        }

        #asset-chips {
          .asset-chip {
            background: #fceee9;
            padding: var(--bb-grid-size) var(--bb-grid-size-2);
            border-radius: var(--bb-grid-size-3);
            margin: var(--bb-grid-size-3) var(--bb-grid-size-3) 0 0;
            display: inline-block;
            font: 400 var(--bb-label-large) / var(--bb-label-line-height-large)
              var(--bb-font-family);
            a,
            a:visited {
              text-decoration: none;
              color: inherit;
            }
            img {
              filter: grayscale();
              vertical-align: middle;
              margin: 0 6px 2px 0;
            }
          }
        }

        #unmanaged-asset-buttons {
          display: flex;
          align-items: flex-end;
          justify-content: flex-end;
          margin-top: var(--bb-grid-size-6);
          flex: 1;
          button {
            margin-left: var(--bb-grid-size-3);
          }
          .bb-button-text {
            color: #000;
          }
          .bb-button-filled {
            background: #000;
            color: #fff;
          }
        }
      }

      .spinner {
        animation: rotate 1s linear infinite;
        color: var(--light-dark-p-40);
        vertical-align: middle;
      }
    `,
  ];

  @consume({ context: scaContext })
  @property({ attribute: false })
  accessor sca!: SCA;

  get #graph() {
    return this.sca.controller.editor.graph.graph;
  }

  get #panel(): SharePanelStatus {
    return this.#controller.panel;
  }

  get #actions() {
    return this.sca.actions.share;
  }

  get #controller() {
    return this.sca.controller.editor.share;
  }

  #dialog = createRef<HTMLDialogElement>();
  #publishedSwitch = createRef<MdSwitch>();
  #googleDriveSharePanel = createRef<GoogleDriveSharePanel>();

  override render() {
    const panel = this.#panel;
    if (panel === "closed") {
      return nothing;
    } else if (panel === "granular") {
      return this.#renderGranularSharingModal();
    } else {
      return this.#renderModal();
    }
  }

  override updated() {
    if (this.#panel === "granular") {
      this.#googleDriveSharePanel.value?.open();
    } else if (this.#panel !== "closed") {
      this.#dialog.value?.showModal();
    }
  }

  open(): void {
    this.#actions.open();
  }

  close(): void {
    this.#actions.closePanel();
  }

  #renderModal() {
    const title = this.#graph?.title;
    return html`
      <dialog
        class=${SHARING_V2 ? "sharing-v2" : ""}
        ${ref(this.#dialog)}
        @close=${this.close}
      >
        <header>
          <h2>Share ${title ? `“${title}”` : ""}</h2>
          <button
            id="close-button"
            class="g-icon"
            aria-label="Close"
            @click=${this.close}
          >
            close
          </button>
        </header>

        ${this.#renderModalContents()}
      </dialog>
    `;
  }

  #renderModalContents() {
    const panel = this.#panel;
    if (panel === "loading") {
      return this.#renderLoading();
    }
    if (panel === "writable" || panel === "updating") {
      return CLIENT_DEPLOYMENT_CONFIG.ENABLE_SHARING_2
        ? this.#renderWritableContentsV2()
        : this.#renderWritableContentsV1();
    }
    if (panel === "readonly") {
      return this.#renderReadonlyModalContents();
    }
    if (panel === "unmanaged-assets") {
      return this.#renderUnmanagedAssetsModalContents();
    }
  }

  #renderLoading() {
    return html`
      <div id="loading">
        <span class="g-icon spinner">progress_activity</span>
        Loading ...
      </div>
    `;
  }

  #renderWritableContentsV1() {
    const shared =
      this.#controller.published || this.#controller.granularlyShared;
    return [
      this.#controller.stale && shared ? this.#renderStaleBanner() : nothing,
      html`
        <div id="permissions">
          Publish your ${APP_NAME} ${this.#renderPublishedSwitch()}
        </div>
      `,
      this.#renderDisallowedPublishingNotice(),
      shared && this.#panel !== "updating" ? this.#renderAppLink() : nothing,
      this.#renderGranularSharingLink(),
      this.#renderAdvisory(),
    ];
  }

  #renderWritableContentsV2() {
    const shared =
      this.#controller.published || this.#controller.granularlyShared;
    return [
      this.#controller.stale && shared ? this.#renderStaleBannerV2() : nothing,
      this.#renderAdvisoryV2(),
      this.#renderVisibilityDropdown(),
      this.#computedVisibility !== "only-you"
        ? this.#renderEditorAccessToggle()
        : nothing,
      shared ? this.#renderAppLink() : nothing,
      this.#renderDoneButton(),
    ];
  }

  #renderStaleBanner() {
    return html`
      <div id="stale">
        <p>
          <span class="g-icon">info</span>
          Your app has unpublished changes
        </p>
        <button
          class="bb-button-text"
          .disabled=${this.#panel !== "writable"}
          @click=${this.#onClickPublishStale}
        >
          Update
        </button>
      </div>
    `;
  }

  async #onClickPublishStale() {
    await this.#actions.publishStale();
  }

  #renderStaleBannerV2() {
    return html`
      <div id="stale-v2">
        <span>
          Click update to push these changes. This will override previous
          versions of the link that you shared.
        </span>
        <button
          class="bb-button-text"
          .disabled=${this.#panel !== "writable"}
          @click=${this.#onClickPublishStale}
        >
          ${this.#panel === "updating"
            ? html`<span class="g-icon spin spinner">progress_activity</span>`
            : nothing}
          Update
        </button>
      </div>
    `;
  }

  #renderEditorAccessToggle() {
    return html`
      <div id="editor-access-toggle">
        <label>
          Allow access to editor view and remix
          <span
            class="g-icon info-icon"
            data-tooltip="Allows others to easily see your prompts and make a copy of your Opal"
            >info</span
          >
        </label>
        <md-switch></md-switch>
      </div>
    `;
  }

  #renderReadonlyModalContents() {
    return html`<div id="readonly">${this.#renderAppLink()}</div>`;
  }

  #renderDisallowedPublishingNotice() {
    const panel = this.#panel;
    if (panel !== "writable" && panel !== "updating") {
      return nothing;
    }
    const domain = this.#controller.userDomain;
    if (!domain) {
      return nothing;
    }
    const { disallowPublicPublishing, preferredUrl } =
      this.sca?.services.globalConfig?.domains?.[domain] ?? {};
    if (!disallowPublicPublishing) {
      return nothing;
    }
    return html`
      <p id="disallowed-publishing-notice">
        <span class="g-icon">info</span>
        Publishing is disabled for all users from ${domain}.
        <br />
        ${preferredUrl
          ? html`Please use
              <a href="${preferredUrl}" target="_blank"
                >${new URL(preferredUrl).hostname}</a
              >
              to share with other ${domain} users.`
          : nothing}
      </p>
    `;
  }

  #renderAppLink() {
    const appUrl = this.#actions.computeAppUrl(this.#controller.shareableFile);
    if (!appUrl) {
      return nothing;
    }
    return html`
      <div id="app-link">
        <input
          id="app-link-text"
          type="text"
          readonly
          value=${appUrl}
          @click=${this.#onClickLinkText}
        />
        <button
          id="app-link-copy-button"
          class="bb-button-outlined"
          @click=${this.#onClickCopyLinkButton}
        >
          <span class="g-icon">link</span>
          Copy link
        </button>
      </div>
    `;
  }

  #renderGranularSharingLink() {
    return html`
      <a
        id="granular-sharing-link"
        href=""
        @click=${this.#onClickViewSharePermissions}
        ?disabled=${this.#panel !== "writable"}
      >
        View Share Permissions
      </a>
    `;
  }

  #renderAdvisory() {
    return html`
      <p id="advisory">
        Granting any access to this app reveals all its content and prompts to
        anyone with access. <strong>Share</strong> to grant access only to
        specific people you choose. <strong>Publish</strong> to create a public
        link for anyone that can also be reshared by anyone. Manage your app's
        visibility at any time from the <strong>'Share app'</strong> menu within
        the ${APP_NAME} app - simply toggle publishing off to unpublish. All
        your ${APP_NAME} apps are saved to your Drive. Remember to share
        <a
          href="https://policies.google.com/terms/generative-ai/use-policy"
          target="_blank"
          >responsibly</a
        >.
      </p>
    `;
  }

  #renderAdvisoryV2() {
    return html`
      <p id="advisory-v2">
        Sharing your ${APP_NAME} app makes it available to anyone with the link.
        To restrict access to your app, you can edit your share permissions so
        only you or specific people you specify can view it.
        <a
          href="https://policies.google.com/terms/generative-ai/use-policy"
          target="_blank"
          >Share responsibly</a
        >.
        <a href="https://developers.google.com/opal/faq" target="_blank"
          >Learn more</a
        >.
      </p>
    `;
  }

  #renderDoneButton() {
    return html`
      <footer>
        <button class="bb-button-outlined" @click=${this.close}>Done</button>
      </footer>
    `;
  }

  #renderVisibilityDropdown() {
    return html`<bb-share-visibility-selector
      .value=${this.#computedVisibility}
    ></bb-share-visibility-selector>`;
  }

  get #computedVisibility(): VisibilityLevel {
    if (this.#controller.published) {
      return "anyone";
    }
    if (this.#controller.granularlyShared) {
      return "restricted";
    }
    return "only-you";
  }

  #renderPublishedSwitch() {
    const panel = this.#panel;
    if (panel !== "writable" && panel !== "updating") {
      return nothing;
    }
    const published = this.#controller.published;
    const domain = this.#controller.userDomain;
    const { disallowPublicPublishing } =
      this.sca?.services.globalConfig?.domains?.[domain] ?? {};

    const disabled = disallowPublicPublishing || panel === "updating";
    return html`
      <div id="published-switch-container">
        ${panel === "updating"
          ? html`<span class="g-icon spin spinner">progress_activity</span>`
          : nothing}
        <md-switch
          ${ref(this.#publishedSwitch)}
          ?selected=${published}
          ?disabled=${disabled}
          @change=${this.#onPublishedSwitchChange}
        ></md-switch>
        <label for="publishedSwitch">
          ${published ? "Public" : "Private"}
        </label>
      </div>
    `;
  }

  #renderGranularSharingModal() {
    const panel = this.#panel;
    if (panel !== "granular" || !this.#controller.shareableFile) {
      return nothing;
    }
    return html`
      <bb-google-drive-share-panel
        ${ref(this.#googleDriveSharePanel)}
        .fileIds=${[this.#controller.shareableFile.id]}
        @close=${this.#onGoogleDriveSharePanelClose}
      ></bb-google-drive-share-panel>
    `;
  }

  #renderUnmanagedAssetsModalContents() {
    const problems = this.#controller.unmanagedAssetProblems;
    if (problems.length === 0) {
      return nothing;
    }

    const parts = [];

    const missingProblems = problems.filter(
      ({ problem }) => problem === "missing"
    );
    if (missingProblems.length > 0) {
      const missingChips = missingProblems.map(({ asset }) => {
        return html`
          <span class="asset-chip">
            <img src=${asset.iconLink} />
            <a href=${driveOpenUrl(asset)} target="_blank">${asset.name}</a>
          </span>
        `;
      });
      parts.push(html`
        <p>
          The following assets are editable by you, but are not yet shared with
          all users of this app. To share them now, choose "Share my assets".
        </p>
        <div id="asset-chips">${missingChips}</div>
      `);
    }

    const cantShareProblems = problems.filter(
      ({ problem }) => problem === "cant-share"
    );
    if (cantShareProblems.length > 0) {
      const cantShareChips = cantShareProblems.map(({ asset }) => {
        return html`
          <span class="asset-chip">
            <img src=${asset.iconLink} />
            <a href=${driveOpenUrl(asset)} target="_blank">${asset.name}</a>
          </span>
        `;
      });
      parts.push(html`
        <p>
          The following assets are <strong>not</strong> editable by you, and we
          unable to verify whether they are shared with all users of this app.
          If you believe the assets are shared (e.g. they are public), you may
          safely ignore this warning. If you are unsure, contact the owner of
          the asset, or replace it with an asset you do own.
        </p>
        <div id="asset-chips">${cantShareChips}</div>
      `);
    }

    if (missingProblems.length > 0) {
      parts.push(html`
        <div id="unmanaged-asset-buttons">
          <button
            class="bb-button-text"
            @click=${this.#onClickDismissUnmanagedAssetProblems}
          >
            Ignore
          </button>
          <button
            id="share-unmanaged-assets-button"
            class="bb-button-filled"
            @click=${this.#onClickFixUnmanagedAssetProblems}
          >
            Share my assets
          </button>
        </div>
      `);
    } else {
      parts.push(html`
        <div id="unmanaged-asset-buttons">
          <button
            class="bb-button-filled"
            @click=${this.#onClickDismissUnmanagedAssetProblems}
          >
            I understand
          </button>
        </div>
      `);
    }
    return html`<div id="unmanaged-assets">${parts}</div>`;
  }

  async #onClickDismissUnmanagedAssetProblems() {
    await this.#actions.dismissUnmanagedAssetProblems();
  }
  async #onClickFixUnmanagedAssetProblems() {
    await this.#actions.fixUnmanagedAssetProblems();
  }

  async #onClickViewSharePermissions(event: MouseEvent) {
    event.preventDefault();
    await this.#actions.viewSharePermissions();
  }

  #onPublishedSwitchChange() {
    const input = this.#publishedSwitch.value;
    if (!input) {
      console.error("Expected input element to be rendered");
      return;
    }
    if (!this.#graph?.url) {
      console.error("No graph url");
      return;
    }
    const selected = input.selected;
    if (selected) {
      this.sca?.services.actionTracker?.publishApp(this.#graph.url);
      this.#actions.publish();
    } else {
      this.#actions.unpublish();
    }
  }

  async #onClickLinkText(event: MouseEvent & { target: HTMLInputElement }) {
    event.target.select();
  }

  async #onClickCopyLinkButton() {
    const appUrl = this.#actions.computeAppUrl(this.#controller.shareableFile);
    if (!appUrl) {
      console.error("No app url");
      return;
    }
    await navigator.clipboard.writeText(appUrl);
    this.dispatchEvent(
      new ToastEvent(
        Strings.from("STATUS_COPIED_TO_CLIPBOARD"),
        ToastType.INFORMATION
      )
    );
  }

  async #onGoogleDriveSharePanelClose() {
    await this.#actions.onGoogleDriveSharePanelClose();
  }
}

declare global {
  interface HTMLElementTagNameMap {
    "bb-share-panel": SharePanel;
  }
}

function driveOpenUrl({ id, resourceKey }: DriveFileId): string {
  const url = new URL("https://drive.google.com/open");
  url.searchParams.set("id", id);
  if (resourceKey) {
    url.searchParams.set("resourcekey", resourceKey);
  }
  return url.href;
}
